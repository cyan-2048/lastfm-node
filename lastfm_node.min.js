!function(e){class r{constructor(){this._eventHandlers={}}isValidType(e){return"string"==typeof e}isValidHandler(e){return"function"==typeof e}on(e,r){if(!e||!r)return!1;if(!this.isValidType(e))return!1;if(!this.isValidHandler(r))return!1;let t=this._eventHandlers[e];return t||(t=this._eventHandlers[e]=[]),!(t.indexOf(r)>=0)&&(r._once=!1,t.push(r),!0)}once(e,r){if(!e||!r)return!1;if(!this.isValidType(e))return!1;if(!this.isValidHandler(r))return!1;const t=this.on(e,r);return t&&(r._once=!0),t}off(e,r){if(!e)return this.offAll();if(!r)return void(this._eventHandlers[e]=[]);if(!this.isValidType(e))return;if(!this.isValidHandler(r))return;const t=this._eventHandlers[e];if(t&&t.length)for(let e=0;e<t.length;e++){if(t[e]===r){t.splice(e,1);break}}}offAll(){this._eventHandlers={}}emit(e,r){if(!e||!this.isValidType(e))return;const t=this._eventHandlers[e];if(!t||!t.length)return;const n=this.createEvent(e,r);for(const r of t)this.isValidHandler(r)&&(r._once&&(n.once=!0),r(n),n.once&&this.off(e,r))}has(e,r){if(!e||!this.isValidType(e))return!1;const t=this._eventHandlers[e];return!(!t||!t.length)&&(!r||!this.isValidHandler(r)||t.indexOf(r)>=0)}getHandlers(e){return e&&this.isValidType(e)&&this._eventHandlers[e]||[]}createEvent(e,r,t=!1){return{type:e,data:r,timestamp:Date.now(),once:t}}}function t(e,r){return Object.keys(e).forEach(t=>{r(e[t],t)})}class n extends r{constructor(){super()}registerHandlers(e){if("object"==typeof e){var r=this;t(e,function(e,t){r.on(t,e)})}}filterParameters(e,r){var n={};return t(e,function(e,t){var s;["error","success","handlers"].includes(s=t)||(r||[]).includes(s)||(n[t]=e)}),n}scheduleCallback(e,r){return setTimeout(e,r)}cancelCallback(e){clearTimeout(e)}}class s extends n{constructor(e,r,t,n){var s=[11,16,29],i=[1e4,3e4,6e4,3e5,9e5,18e5],o=this;n=n||{},super(),function(e){o.registerHandlers(e.handlers)}(n),t.isAuthorised()?"scrobble"!==r&&"nowplaying"!==r||function(r,n){if("scrobble"==r&&!n.timestamp)return void o.emit("error",{error:6,message:"Invalid parameters - Timestamp is required for scrobbling"});var a=0,u=function(e){var r=o.filterParameters(e);return r.sk=t.key,r}(n),c="scrobble"==r?"track.scrobble":"track.updateNowPlaying";function l(){var r=e.request(c,u);r.on("error",f),r.on("success",d)}function d(e){e&&o.emit("success",n.track)}function f(e){if(function(e){return"scrobble"==r&&s.includes(e.error)}(e)){var t=function(e){var r=Math.min(e,i.length-1);return i[r]}(a++),n={error:e.error,message:e.message,delay:t};return o.emit("retrying",n),void o.scheduleCallback(l,t)}!function(e){o.emit("error",e)}(e)}l()}(r,n):this.emit("error",{error:4,message:"Authentication failed"})}}class i extends n{constructor(e,r,t){r=r||{};var n=this,s=!0;function i(r,t){(function(e){n.registerHandlers(e.handlers)})(t=t||{}),function r(t,i){i=i||{};if(!t)return void n.emit("error",new Error("No token supplied"));var a={token:t},u=e.request("auth.getsession",a);u.on("success",o);u.on("error",function(e){if(function(e){return 14==e.error||16==e.error||11==e.error}(e)){if(!s)return;var o=i.retryInterval||1e4;return n.emit("retrying",{error:e.error,message:e.message,delay:o}),void n.scheduleCallback(function(){r(t,i)},o)}!function(e){n.emit("error",e)}(e)})}(r,t)}function o(e){var r;e.session?(r=e.session,n.user=r.name,n.key=r.key,n.emit("authorised",n),n.emit("success",n)):n.emit("error",new Error("Unexpected error"))}super(),"object"!=typeof r?(this.user=r||"",this.key=t||""):(this.user=r.user||"",this.key=r.key||""),r.token&&i(r.token,r),this.authorise=function(e,r){i(e,r)},this.cancel=function(){s=!1}}isAuthorised(){return""!==this.key}}class o extends n{constructor(e,r,t){var n=["track.scrobble","track.updatenowplaying"],s=["auth.getmobilesession","auth.getsession","auth.gettoken","radio.getplaylist","user.getrecentstations","user.getrecommendedartists","user.getrecommendedevents"],i=this;function o(){return t.signed||a()||function(e){return e&&s.includes(e.toLowerCase())}(r)}function a(){return t.write||function(e){return e&&n.includes(e.toLowerCase())}(r)}super(),t=t||{},i.registerHandlers(t.handlers),function(t,n,s){var u=a()?"POST":"GET";var c=function(e){var r=[];for(var t in e)e.hasOwnProperty(t)&&r.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return r.join("&")}(function(t){var n=i.filterParameters(t,["signed","write"]);n.method=r,n.api_key=n.api_key||e.api_key,n.format=n.format||e.format,o()&&(n.api_sig=function(e,r){var t="";return Object.keys(e).sort().forEach(function(r){if("format"!=r){var n=void 0!==e[r]&&null!==e[r]?e[r]:"";t+=r+n}}),t+=r,md5(t)}(n,e.secret));return n}(s));"GET"==u&&(n+="?"+c);var l={method:u,headers:function(e,r,t){var n={};"POST"==e&&(n["Content-Length"]=t.length,n["Content-Type"]="application/x-www-form-urlencoded");return n}(u,0,c),body:"POST"==u?c:null};fetch(t+n,l).then(e=>e.json()).then(e=>i.emit("success",e)).catch(e=>i.emit("error",e))}(e.host,e.url,t)}}window.LastFmNode=class{constructor(e){e=e||{},this.url="/2.0/",this.host=e.host||"http://ws.audioscrobbler.com",this.format="json",this.secret=e.secret,this.api_key=e.api_key}request(e,r){return new o(this,e,r)}update(e,r,t){return new s(this,e,r,t)}session(e,r){return new i(this,e,r)}}}();